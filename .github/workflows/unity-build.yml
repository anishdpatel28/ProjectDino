name: Unity CI

# Trigger on pushes to main and on all pull requests
on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  UNITY_VERSION: 6000.3.9f1

jobs:
  # ─────────────────────────────────────────────────────────────
  # JOB 1 – Run Tests (EditMode + PlayMode)
  # ─────────────────────────────────────────────────────────────
  test:
    name: Run Unity Tests (${{ matrix.testMode }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        testMode:
          - EditMode
          - PlayMode

    steps:
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ matrix.testMode }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ matrix.testMode }}-
            Library-

      # Place the UnityEntitlementLicense.xml onto the host filesystem before Docker runs.
      # game-ci mounts /home/runner/work/_temp/_github_home as /root inside the container.
      # Unity 6's LicensingClient looks for the entitlement license at
      # ~/.local/share/unity3d/licenses/ (Linux equivalent of %LOCALAPPDATA%\Unity\licenses\).
      # Without the file present, LicensingClient falls back to an online machine-bound lookup
      # which fails in CI (different machine than where the license was originally issued).
      # With the file present, LicensingClient reads the entitlements locally, finds
      # com.unity.editor.headless, and activation succeeds.
      - name: Place Unity entitlement license for offline activation
        run: |
          GITHUB_HOME="/home/runner/work/_temp/_github_home"
          mkdir -p "$GITHUB_HOME/.local/share/unity3d/licenses"
          mkdir -p "$GITHUB_HOME/.cache/unity3d"
          printf '%s' "$UNITY_LICENSE" > "$GITHUB_HOME/.local/share/unity3d/licenses/UnityEntitlementLicense.xml"
          # Also place in game-ci's unity-config volume mount (/usr/share/unity3d/config/ in container)
          printf '%s' "$UNITY_LICENSE" > /home/runner/work/_actions/game-ci/unity-test-runner/v4/dist/unity-config/UnityEntitlementLicense.xml
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

      # Patch game-ci's activate.sh to remove the -serial flag.
      # game-ci extracts a garbage serial ("x") from UnityEntitlementLicense.xml and passes
      # it as -serial "x". Without this patch, Unity validates the serial and fails (Code 20110).
      # With this patch, Unity authenticates with email/password only, finds the local license
      # file placed in the step above, and activates via entitlement.
      - name: Patch game-ci activate.sh for Unity 6 Personal License
        run: |
          SCRIPT="/home/runner/work/_actions/game-ci/unity-test-runner/v4/dist/platforms/ubuntu/activate.sh"
          cat > "$SCRIPT" << 'PATCHEOF'
          #!/usr/bin/env bash
          if [[ -n "$UNITY_EMAIL" && -n "$UNITY_PASSWORD" ]]; then
            echo "Requesting activation (Unity 6 Personal – entitlement, no serial)"
            retry_count=0
            delay=15
            while [[ $retry_count -lt 5 ]]; do
              unity-editor \
                -logFile /dev/stdout \
                -quit \
                -username "$UNITY_EMAIL" \
                -password "$UNITY_PASSWORD" \
                -projectPath "/BlankProject"
              UNITY_EXIT_CODE=$?
              if [[ $UNITY_EXIT_CODE -eq 0 ]]; then
                echo "Activation successful"
                break
              else
                ((retry_count++))
                echo "::warning ::Activation failed, attempting retry #$retry_count"
                echo "Activation failed, retrying in $delay seconds..."
                sleep $delay
                delay=$((delay * 2))
              fi
            done
            if [[ $retry_count -eq 5 ]]; then
              echo "Activation failed after 5 retries"
            fi
          else
            echo "::error ::UNITY_EMAIL and UNITY_PASSWORD must be set."
            exit 1
          fi
          if [[ $UNITY_EXIT_CODE -eq 0 ]]; then
            echo "Activation complete."
          else
            echo "Unclassified error occurred while trying to activate license."
            echo "Exit code was: $UNITY_EXIT_CODE"
            echo "::error ::There was an error while trying to activate the Unity license."
            exit $UNITY_EXIT_CODE
          fi
          PATCHEOF
          chmod +x "$SCRIPT"

      - name: Run ${{ matrix.testMode }} tests
        uses: game-ci/unity-test-runner@v4
        id: tests
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: ${{ matrix.testMode }}
          artifactsPath: TestResults/${{ matrix.testMode }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: ${{ matrix.testMode }} Test Results

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: TestResults-${{ matrix.testMode }}
          path: ${{ steps.tests.outputs.artifactsPath }}
          retention-days: 14

  # ─────────────────────────────────────────────────────────────
  # JOB 2 – Build for Windows Standalone
  # ─────────────────────────────────────────────────────────────
  build:
    name: Build – Windows Standalone
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-Build-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Build-
            Library-

      - name: Place Unity entitlement license for offline activation
        run: |
          GITHUB_HOME="/home/runner/work/_temp/_github_home"
          mkdir -p "$GITHUB_HOME/.local/share/unity3d/licenses"
          mkdir -p "$GITHUB_HOME/.cache/unity3d"
          printf '%s' "$UNITY_LICENSE" > "$GITHUB_HOME/.local/share/unity3d/licenses/UnityEntitlementLicense.xml"
          printf '%s' "$UNITY_LICENSE" > /home/runner/work/_actions/game-ci/unity-builder/v4/dist/unity-config/UnityEntitlementLicense.xml
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

      - name: Patch game-ci activate.sh for Unity 6 Personal License
        run: |
          SCRIPT="/home/runner/work/_actions/game-ci/unity-builder/v4/dist/platforms/ubuntu/steps/activate.sh"
          cat > "$SCRIPT" << 'PATCHEOF'
          #!/usr/bin/env bash
          if [[ ! -d "/BlankProject" ]]; then mkdir /BlankProject; fi
          if [[ ! -d "/BlankProject/Assets" ]]; then mkdir /BlankProject/Assets; fi
          if [[ -n "$UNITY_EMAIL" && -n "$UNITY_PASSWORD" ]]; then
            echo "Requesting activation (Unity 6 Personal – entitlement, no serial)"
            retry_count=0
            delay=15
            while [[ $retry_count -lt 5 ]]; do
              unity-editor \
                -logFile /dev/stdout \
                -quit \
                -username "$UNITY_EMAIL" \
                -password "$UNITY_PASSWORD" \
                -projectPath "/BlankProject"
              UNITY_EXIT_CODE=$?
              if [[ $UNITY_EXIT_CODE -eq 0 ]]; then
                echo "Activation successful"
                break
              else
                ((retry_count++))
                echo "::warning ::Activation failed, attempting retry #$retry_count"
                echo "Activation failed, retrying in $delay seconds..."
                sleep $delay
                delay=$((delay * 2))
              fi
            done
            if [[ $retry_count -eq 5 ]]; then
              echo "Activation failed after 5 retries"
            fi
          else
            echo "::error ::UNITY_EMAIL and UNITY_PASSWORD must be set."
            exit 1
          fi
          if [[ $UNITY_EXIT_CODE -eq 0 ]]; then
            echo "Activation complete."
          else
            echo "Unclassified error occurred while trying to activate license."
            echo "Exit code was: $UNITY_EXIT_CODE"
            echo "::error ::There was an error while trying to activate the Unity license."
            exit $UNITY_EXIT_CODE
          fi
          PATCHEOF
          chmod +x "$SCRIPT"

      - name: Build Windows Standalone
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: StandaloneWindows64
          buildsPath: build

      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Build-StandaloneWindows64
          path: build/StandaloneWindows64
          retention-days: 30
