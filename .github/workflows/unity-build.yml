name: Unity CI

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  # Path to Unity.exe on your self-hosted runner machine
  UNITY_PATH: C:\Program Files\Unity\Hub\Editor\6000.3.9f1\Editor\Unity.exe

jobs:
  # ─────────────────────────────────────────────────────────────
  # JOB 1 – Run Tests (EditMode + PlayMode)
  # ─────────────────────────────────────────────────────────────
  test:
    name: Run Unity Tests (${{ matrix.testMode }})
    runs-on: [self-hosted, Windows, X64]

    strategy:
      fail-fast: false
      matrix:
        testMode:
          - EditMode
          - PlayMode

    steps:
      # Check out the repo, pulling Git LFS files too
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      # Cache the Library folder so Unity doesn't reimport everything each run
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ matrix.testMode }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ matrix.testMode }}-
            Library-

      # Run the Unity Test Runner in batch mode (no activation needed — Unity is
      # already licensed on this machine from your normal Unity Hub login)
      - name: Run ${{ matrix.testMode }} tests
        shell: powershell
        run: |
          $unityExe  = $env:UNITY_PATH
          $projectPath = $env:GITHUB_WORKSPACE
          $resultsDir  = "$projectPath\TestResults\${{ matrix.testMode }}"
          $logFile     = "$projectPath\unity-test-${{ matrix.testMode }}.log"

          New-Item -ItemType Directory -Force -Path $resultsDir | Out-Null

          & "$unityExe" `
            -batchmode `
            -nographics `
            -projectPath "$projectPath" `
            -runTests `
            -testPlatform ${{ matrix.testMode }} `
            -testResults  "$resultsDir\results.xml" `
            -logFile      "$logFile" `
            -quit

          $exitCode = $LASTEXITCODE

          # Always print the Unity log so failures are visible in the Actions UI
          if (Test-Path $logFile) { Get-Content $logFile }

          # Exit code 2 = tests ran but some failed (still a legitimate result to upload)
          if ($exitCode -eq 2) {
            Write-Warning "Some tests failed (Unity exit code 2)."
          } elseif ($exitCode -ne 0) {
            Write-Error "Unity exited with code $exitCode"
            exit $exitCode
          }

      # Upload the NUnit XML so GitHub shows a test-results summary
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: TestResults-${{ matrix.testMode }}
          path: TestResults/${{ matrix.testMode }}
          retention-days: 14

  # ─────────────────────────────────────────────────────────────
  # JOB 2 – Build for Windows Standalone
  # ─────────────────────────────────────────────────────────────
  build:
    name: Build – Windows Standalone
    runs-on: [self-hosted, Windows, X64]
    needs: test

    steps:
      # Check out the repo, pulling Git LFS files too
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      # Cache the Library folder
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-Build-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Build-
            Library-

      # Build the Windows 64-bit standalone player
      - name: Build Windows Standalone
        shell: powershell
        run: |
          $unityExe   = $env:UNITY_PATH
          $projectPath = $env:GITHUB_WORKSPACE
          $buildDir    = "$projectPath\build\StandaloneWindows64"
          $logFile     = "$projectPath\unity-build.log"

          New-Item -ItemType Directory -Force -Path $buildDir | Out-Null

          & "$unityExe" `
            -batchmode `
            -nographics `
            -projectPath  "$projectPath" `
            -buildWindows64Player "$buildDir\ProjectDino.exe" `
            -logFile      "$logFile" `
            -quit

          $exitCode = $LASTEXITCODE
          if (Test-Path $logFile) { Get-Content $logFile }
          if ($exitCode -ne 0) {
            Write-Error "Unity build failed with exit code $exitCode"
            exit $exitCode
          }

      # Upload the finished build as a downloadable artifact
      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Build-StandaloneWindows64
          path: build/StandaloneWindows64
          retention-days: 30
