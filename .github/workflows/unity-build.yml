name: Unity CI

# Trigger on pushes to main and on all pull requests
on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  # Set your Unity version here once and reuse it across all jobs
  UNITY_VERSION: 6000.3.9f1

jobs:
  # ─────────────────────────────────────────────────────────────
  # JOB 1 – Run Tests (EditMode + PlayMode)
  # ─────────────────────────────────────────────────────────────
  test:
    name: Run Unity Tests (${{ matrix.testMode }})
    runs-on: ubuntu-latest

    # Run this job twice in parallel: once for EditMode, once for PlayMode
    strategy:
      fail-fast: false
      matrix:
        testMode:
          - EditMode
          - PlayMode

    steps:
      # Step 1 – Check out the repository including all Git LFS objects
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true          # Downloads Git LFS pointers as real files
          fetch-depth: 0     # Full history needed for some Unity packages

      # Step 2 – Cache the Unity Library folder between runs to speed up builds
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ matrix.testMode }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ matrix.testMode }}-
            Library-

      # Step 3 – Patch game-ci's activate.sh so Unity 6 Personal license works.
      # Root cause: game-ci extracts a garbage serial ("x") from UnityEntitlementLicense.xml
      # and passes it as -serial "x" to unity-editor. Unity 6 fails with Code 20110
      # (serial invalid) because Personal plans have no serial.
      # Fix: replace activate.sh with a version that uses email+password only (no serial).
      - name: Patch game-ci activate.sh for Unity 6 Personal License
        run: |
          SCRIPT="/home/runner/work/_actions/game-ci/unity-test-runner/v4/dist/platforms/ubuntu/activate.sh"
          cat > "$SCRIPT" << 'PATCHEOF'
          #!/usr/bin/env bash
          if [[ -n "$UNITY_EMAIL" && -n "$UNITY_PASSWORD" ]]; then
            echo "Requesting activation (Unity 6 Personal – entitlement, no serial)"
            retry_count=0
            delay=15
            while [[ $retry_count -lt 5 ]]; do
              unity-editor \
                -logFile /dev/stdout \
                -quit \
                -username "$UNITY_EMAIL" \
                -password "$UNITY_PASSWORD" \
                -projectPath "/BlankProject"
              UNITY_EXIT_CODE=$?
              if [[ $UNITY_EXIT_CODE -eq 0 ]]; then
                echo "Activation successful"
                break
              else
                ((retry_count++))
                echo "::warning ::Activation failed, attempting retry #$retry_count"
                echo "Activation failed, retrying in $delay seconds..."
                sleep $delay
                delay=$((delay * 2))
              fi
            done
            if [[ $retry_count -eq 5 ]]; then
              echo "Activation failed after 5 retries"
            fi
          else
            echo "::error ::UNITY_EMAIL and UNITY_PASSWORD must be set."
            exit 1
          fi
          if [[ $UNITY_EXIT_CODE -eq 0 ]]; then
            echo "Activation complete."
          else
            echo "Unclassified error occurred while trying to activate license."
            echo "Exit code was: $UNITY_EXIT_CODE"
            echo "::error ::There was an error while trying to activate the Unity license."
            exit $UNITY_EXIT_CODE
          fi
          PATCHEOF
          chmod +x "$SCRIPT"

      # Step 4 – Run the Unity Test Runner for the current matrix test mode
      - name: Run ${{ matrix.testMode }} tests
        uses: game-ci/unity-test-runner@v4
        id: tests
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: ${{ matrix.testMode }}
          # Write NUnit XML results to a dedicated folder so they can be uploaded
          artifactsPath: TestResults/${{ matrix.testMode }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: ${{ matrix.testMode }} Test Results

      # Step 5 – Upload the NUnit XML test results as a build artifact
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()   # Upload even when tests fail so we can inspect failures
        with:
          name: TestResults-${{ matrix.testMode }}
          path: ${{ steps.tests.outputs.artifactsPath }}
          retention-days: 14

  # ─────────────────────────────────────────────────────────────
  # JOB 2 – Build for Windows Standalone
  # Runs only after tests pass (needs: test)
  # ─────────────────────────────────────────────────────────────
  build:
    name: Build – Windows Standalone
    runs-on: ubuntu-latest
    needs: test   # Only build if all test jobs succeed

    steps:
      # Step 1 – Check out the repository including all Git LFS objects
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      # Step 2 – Cache the Unity Library folder to avoid re-importing every run
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-Build-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Build-
            Library-

      # Step 3 – Patch game-ci's activate.sh (same fix as in the test job)
      - name: Patch game-ci activate.sh for Unity 6 Personal License
        run: |
          SCRIPT="/home/runner/work/_actions/game-ci/unity-builder/v4/dist/platforms/ubuntu/steps/activate.sh"
          cat > "$SCRIPT" << 'PATCHEOF'
          #!/usr/bin/env bash
          if [[ ! -d "/BlankProject" ]]; then mkdir /BlankProject; fi
          if [[ ! -d "/BlankProject/Assets" ]]; then mkdir /BlankProject/Assets; fi
          if [[ -n "$UNITY_EMAIL" && -n "$UNITY_PASSWORD" ]]; then
            echo "Requesting activation (Unity 6 Personal – entitlement, no serial)"
            retry_count=0
            delay=15
            while [[ $retry_count -lt 5 ]]; do
              unity-editor \
                -logFile /dev/stdout \
                -quit \
                -username "$UNITY_EMAIL" \
                -password "$UNITY_PASSWORD" \
                -projectPath "/BlankProject"
              UNITY_EXIT_CODE=$?
              if [[ $UNITY_EXIT_CODE -eq 0 ]]; then
                echo "Activation successful"
                break
              else
                ((retry_count++))
                echo "::warning ::Activation failed, attempting retry #$retry_count"
                echo "Activation failed, retrying in $delay seconds..."
                sleep $delay
                delay=$((delay * 2))
              fi
            done
            if [[ $retry_count -eq 5 ]]; then
              echo "Activation failed after 5 retries"
            fi
          else
            echo "::error ::UNITY_EMAIL and UNITY_PASSWORD must be set."
            exit 1
          fi
          if [[ $UNITY_EXIT_CODE -eq 0 ]]; then
            echo "Activation complete."
          else
            echo "Unclassified error occurred while trying to activate license."
            echo "Exit code was: $UNITY_EXIT_CODE"
            echo "::error ::There was an error while trying to activate the Unity license."
            exit $UNITY_EXIT_CODE
          fi
          PATCHEOF
          chmod +x "$SCRIPT"

      # Step 4 – Build the project for Windows Standalone (64-bit)
      - name: Build Windows Standalone
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: StandaloneWindows64
          # The output folder inside the runner; artifacts are uploaded next
          buildsPath: build

      # Step 5 – Upload the compiled Windows build as a downloadable artifact
      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Build-StandaloneWindows64
          path: build/StandaloneWindows64   # game-ci places output here by default
          retention-days: 30
