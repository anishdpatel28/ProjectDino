name: Unity CI

on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  UNITY_VERSION: 6000.3.9f1

jobs:
  # ─────────────────────────────────────────────────────────────
  # JOB 1 – Run Tests (EditMode + PlayMode)
  # ─────────────────────────────────────────────────────────────
  test:
    name: Run Unity Tests (${{ matrix.testMode }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        testMode:
          - EditMode
          - PlayMode

    steps:
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ matrix.testMode }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ matrix.testMode }}-
            Library-

      # Pre-create the directories Unity's LicensingClient writes to inside Docker.
      # game-ci mounts _github_home as /root in the container, so files written here
      # persist across unity-editor invocations within the same job.
      - name: Prepare Unity license directories and place entitlement file
        run: |
          GITHUB_HOME="/home/runner/work/_temp/_github_home"
          mkdir -p "$GITHUB_HOME/.local/share/unity3d/licenses"
          mkdir -p "$GITHUB_HOME/.cache/unity3d"
          # Place license at the Linux equivalent of %LOCALAPPDATA%\Unity\licenses\
          printf '%s' "$UNITY_LICENSE" > "$GITHUB_HOME/.local/share/unity3d/licenses/UnityEntitlementLicense.xml"
          # Also place in game-ci's unity-config mount (/usr/share/unity3d/config/ inside container)
          printf '%s' "$UNITY_LICENSE" > /home/runner/work/_actions/game-ci/unity-test-runner/v4/dist/unity-config/UnityEntitlementLicense.xml
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

      # Patch game-ci's activate.sh with a strategy that works for Unity 6 Personal licenses.
      #
      # Background:
      #   - game-ci passes UNITY_SERIAL=x to the container (extracted from UnityEntitlementLicense.xml
      #     which has no real serial, so game-ci falls back to "x").
      #   - Original activate.sh uses -serial "x" which triggers Unity's account-based entitlement
      #     lookup. The lookup SUCCEEDS ("Successfully activated the entitlement license") because
      #     the server uses email/password auth to find the account's Personal plan entitlements.
      #     BUT THEN Unity validates the serial "x" → fails with Code 20110 (serial invalid).
      #   - Our previous fix removed -serial, using email+password only. But without a serial,
      #     Unity's server does a machine-ID lookup instead of account lookup, and the CI runner's
      #     machine ID has no registered entitlements → Code 404.
      #
      # New strategy:
      #   - Keep -serial "$UNITY_SERIAL" (which is "x") to trigger the account-based entitlement lookup.
      #   - Capture the log and check for "Successfully activated the entitlement license".
      #   - If found, exit 0 immediately (tolerate Code 20110; the LicensingClient wrote its state).
      #   - If not found (genuine Code 404 / network issue), retry up to 5 times.
      #   - The test runner (run_tests.sh, same Docker container) will find whatever the
      #     LicensingClient wrote to /root/.local/share/unity3d/ during the activation window.
      - name: Patch game-ci activate.sh for Unity 6 Personal License
        run: |
          SCRIPT="/home/runner/work/_actions/game-ci/unity-test-runner/v4/dist/platforms/ubuntu/activate.sh"
          cat > "$SCRIPT" << 'PATCHEOF'
          #!/usr/bin/env bash
          if [[ -n "$UNITY_EMAIL" && -n "$UNITY_PASSWORD" ]]; then
            echo "Requesting activation (Unity 6 Personal – serial path for account entitlement lookup)"
            retry_count=0
            delay=15
            ACTIVATION_SUCCESS=false
            while [[ $retry_count -lt 5 ]]; do
              LOGFILE=$(mktemp /tmp/unity_act.XXXXXX)
              unity-editor \
                -logFile "$LOGFILE" \
                -quit \
                -username "$UNITY_EMAIL" \
                -password "$UNITY_PASSWORD" \
                -serial "${UNITY_SERIAL:-x}" \
                -projectPath "/BlankProject" || true
              cat "$LOGFILE"
              if grep -q "Successfully activated the entitlement license" "$LOGFILE"; then
                echo "Entitlement found and activated (Code 20110 serial mismatch is expected for Unity 6 Personal – tolerated)."
                ACTIVATION_SUCCESS=true
                rm -f "$LOGFILE"
                break
              else
                rm -f "$LOGFILE"
                ((retry_count++))
                echo "::warning ::Entitlement not found (Code 404), retry #$retry_count"
                echo "Retrying in $delay seconds..."
                sleep $delay
                delay=$((delay * 2))
              fi
            done
            if [[ "$ACTIVATION_SUCCESS" != "true" ]]; then
              echo "Activation failed: entitlement was never found after 5 attempts."
              echo "::error ::There was an error while trying to activate the Unity license."
              exit 1
            fi
          else
            echo "::error ::UNITY_EMAIL and UNITY_PASSWORD must be set."
            exit 1
          fi
          echo "Activation complete."
          PATCHEOF
          chmod +x "$SCRIPT"

      - name: Run ${{ matrix.testMode }} tests
        uses: game-ci/unity-test-runner@v4
        id: tests
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: ${{ matrix.testMode }}
          artifactsPath: TestResults/${{ matrix.testMode }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: ${{ matrix.testMode }} Test Results

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: TestResults-${{ matrix.testMode }}
          path: ${{ steps.tests.outputs.artifactsPath }}
          retention-days: 14

  # ─────────────────────────────────────────────────────────────
  # JOB 2 – Build for Windows Standalone
  # ─────────────────────────────────────────────────────────────
  build:
    name: Build – Windows Standalone
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-Build-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Build-
            Library-

      - name: Prepare Unity license directories and place entitlement file
        run: |
          GITHUB_HOME="/home/runner/work/_temp/_github_home"
          mkdir -p "$GITHUB_HOME/.local/share/unity3d/licenses"
          mkdir -p "$GITHUB_HOME/.cache/unity3d"
          printf '%s' "$UNITY_LICENSE" > "$GITHUB_HOME/.local/share/unity3d/licenses/UnityEntitlementLicense.xml"
          printf '%s' "$UNITY_LICENSE" > /home/runner/work/_actions/game-ci/unity-builder/v4/dist/unity-config/UnityEntitlementLicense.xml
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}

      - name: Patch game-ci activate.sh for Unity 6 Personal License
        run: |
          SCRIPT="/home/runner/work/_actions/game-ci/unity-builder/v4/dist/platforms/ubuntu/steps/activate.sh"
          cat > "$SCRIPT" << 'PATCHEOF'
          #!/usr/bin/env bash
          if [[ ! -d "/BlankProject" ]]; then mkdir /BlankProject; fi
          if [[ ! -d "/BlankProject/Assets" ]]; then mkdir /BlankProject/Assets; fi
          if [[ -n "$UNITY_EMAIL" && -n "$UNITY_PASSWORD" ]]; then
            echo "Requesting activation (Unity 6 Personal – serial path for account entitlement lookup)"
            retry_count=0
            delay=15
            ACTIVATION_SUCCESS=false
            while [[ $retry_count -lt 5 ]]; do
              LOGFILE=$(mktemp /tmp/unity_act.XXXXXX)
              unity-editor \
                -logFile "$LOGFILE" \
                -quit \
                -username "$UNITY_EMAIL" \
                -password "$UNITY_PASSWORD" \
                -serial "${UNITY_SERIAL:-x}" \
                -projectPath "/BlankProject" || true
              cat "$LOGFILE"
              if grep -q "Successfully activated the entitlement license" "$LOGFILE"; then
                echo "Entitlement found and activated (Code 20110 serial mismatch is expected for Unity 6 Personal – tolerated)."
                ACTIVATION_SUCCESS=true
                rm -f "$LOGFILE"
                break
              else
                rm -f "$LOGFILE"
                ((retry_count++))
                echo "::warning ::Entitlement not found (Code 404), retry #$retry_count"
                echo "Retrying in $delay seconds..."
                sleep $delay
                delay=$((delay * 2))
              fi
            done
            if [[ "$ACTIVATION_SUCCESS" != "true" ]]; then
              echo "Activation failed: entitlement was never found after 5 attempts."
              echo "::error ::There was an error while trying to activate the Unity license."
              exit 1
            fi
          else
            echo "::error ::UNITY_EMAIL and UNITY_PASSWORD must be set."
            exit 1
          fi
          echo "Activation complete."
          PATCHEOF
          chmod +x "$SCRIPT"

      - name: Build Windows Standalone
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: StandaloneWindows64
          buildsPath: build

      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Build-StandaloneWindows64
          path: build/StandaloneWindows64
          retention-days: 30
