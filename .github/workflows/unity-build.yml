name: Unity CI

# Trigger on pushes to main and on all pull requests
on:
  push:
    branches:
      - master
      - main
  pull_request:
    branches:
      - master
      - main
  workflow_dispatch:

env:
  # Set your Unity version here once and reuse it across all jobs
  UNITY_VERSION: 6000.3.9f1

jobs:
  # ─────────────────────────────────────────────────────────────
  # JOB 1 – Run Tests (EditMode + PlayMode)
  # ─────────────────────────────────────────────────────────────
  test:
    name: Run Unity Tests (${{ matrix.testMode }})
    runs-on: ubuntu-latest

    # Run this job twice in parallel: once for EditMode, once for PlayMode
    strategy:
      fail-fast: false
      matrix:
        testMode:
          - EditMode
          - PlayMode

    steps:
      # Step 1 – Check out the repository including all Git LFS objects
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true          # Downloads Git LFS pointers as real files
          fetch-depth: 0     # Full history needed for some Unity packages

      # Step 2 – Cache the Unity Library folder between runs to speed up builds
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-${{ matrix.testMode }}-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-${{ matrix.testMode }}-
            Library-

      # Step 3 – Run the Unity Test Runner for the current matrix test mode
      # unity-test-runner@v4 handles Unity activation internally using the credentials below.
      - name: Run ${{ matrix.testMode }} tests  # Step 3
        uses: game-ci/unity-test-runner@v4
        id: tests
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          testMode: ${{ matrix.testMode }}
          # Write NUnit XML results to a dedicated folder so they can be uploaded
          artifactsPath: TestResults/${{ matrix.testMode }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
          checkName: ${{ matrix.testMode }} Test Results

      # Step 4 – Upload the NUnit XML test results as a build artifact
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()   # Upload even when tests fail so we can inspect failures
        with:
          name: TestResults-${{ matrix.testMode }}
          path: ${{ steps.tests.outputs.artifactsPath }}
          retention-days: 14

  # ─────────────────────────────────────────────────────────────
  # JOB 2 – Build for Windows Standalone
  # Runs only after tests pass (needs: test)
  # ─────────────────────────────────────────────────────────────
  build:
    name: Build – Windows Standalone
    runs-on: ubuntu-latest
    needs: test   # Only build if all test jobs succeed

    steps:
      # Step 1 – Check out the repository including all Git LFS objects
      - name: Checkout repository (with Git LFS)
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      # Step 2 – Cache the Unity Library folder to avoid re-importing every run
      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Library
          key: Library-Build-${{ hashFiles('Assets/**', 'Packages/**', 'ProjectSettings/**') }}
          restore-keys: |
            Library-Build-
            Library-

      # Step 3 – Build the project for Windows Standalone (64-bit)
      # unity-builder@v4 handles Unity activation internally using the credentials below.
      - name: Build Windows Standalone  # Step 3
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          targetPlatform: StandaloneWindows64
          # The output folder inside the runner; artifacts are uploaded next
          buildsPath: build

      # Step 4 – Upload the compiled Windows build as a downloadable artifact
      - name: Upload Windows build artifact
        uses: actions/upload-artifact@v4
        with:
          name: Build-StandaloneWindows64
          path: build/StandaloneWindows64   # game-ci places output here by default
          retention-days: 30
