name: Unity Project Checks

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]

jobs:
  checks:
    name: Project Quality Checks
    runs-on: ubuntu-latest

    steps:
      # Full checkout so we can inspect all files; LFS=true to pull binary assets
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true
          fetch-depth: 0

      # ── 1. Missing .meta files ────────────────────────────────────────────────
      # Every file inside Assets/ must have a .meta sidecar.
      # Missing .meta files cause Unity to re-import assets and break teammates.
      - name: Check for missing .meta files
        run: |
          missing=0
          while IFS= read -r -d '' file; do
            if [[ ! -f "${file}.meta" ]]; then
              echo "::error file=${file}::Missing .meta file: ${file}.meta"
              missing=$((missing + 1))
            fi
          done < <(find Assets -type f ! -name "*.meta" -print0 2>/dev/null)

          if [[ $missing -gt 0 ]]; then
            echo "::error::$missing asset(s) are missing .meta files."
            exit 1
          fi
          echo "✓ All assets have .meta files."

      # ── 2. Large files not tracked by Git LFS ────────────────────────────────
      # Binary files (textures, audio, meshes) larger than 1 MB should be in LFS.
      # If they aren't, they bloat the repo and slow down every clone.
      - name: Check for large files missing Git LFS tracking
        run: |
          warn=0
          lfs_files=$(git lfs ls-files -n 2>/dev/null || true)

          while IFS= read -r tracked_file; do
            [[ -f "$tracked_file" ]] || continue
            size=$(stat -c%s "$tracked_file" 2>/dev/null || echo 0)
            if [[ $size -gt 1048576 ]]; then
              if ! echo "$lfs_files" | grep -qF "$tracked_file"; then
                size_kb=$(( size / 1024 ))
                echo "::warning file=${tracked_file}::Large file not in LFS (${size_kb} KB): ${tracked_file}"
                warn=$((warn + 1))
              fi
            fi
          done < <(git ls-files)

          if [[ $warn -gt 0 ]]; then
            echo "::warning::$warn large file(s) should be tracked by Git LFS."
          else
            echo "✓ No large files outside LFS."
          fi

      # ── 3. Merge conflict markers ─────────────────────────────────────────────
      # Catches leftover <<<<<< / ====== / >>>>>> that slip through during merges.
      - name: Check for merge conflict markers
        run: |
          conflict_files=$(git ls-files \
            | xargs grep -rlE "^(<{7}|={7}|>{7})( |$)" 2>/dev/null || true)

          if [[ -n "$conflict_files" ]]; then
            while IFS= read -r f; do
              echo "::error file=${f}::Merge conflict markers found in: ${f}"
            done <<< "$conflict_files"
            exit 1
          fi
          echo "✓ No merge conflict markers found."

      # ── 4. EditorConfig compliance ────────────────────────────────────────────
      # Validates indentation, charset, and line endings against .editorconfig.
      - name: Check EditorConfig compliance
        uses: editorconfig-checker/action-editorconfig-checker@main
